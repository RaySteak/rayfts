<tr>
    <th colspan="3">
        <hr>
    </th>
</tr>
</tbody>
</table>
<input type="submit" value="Delete selected">
<div class="gap-20"></div>
</form>
<form method="post">
    <input type="text" name="folder_name" placeholder="Folder name" id="folder_name" onkeyup="check()" required>
    <input type="submit" value="Create folder" id="create_folder_button">
    <div class="gap-20" id="error"></div>
</form>
<form method="post" enctype="multipart/form-data">
    <input type="file" id="file1" name="filename" onchange="uploadFile()">
    <br>
    <progress id="progressBar" value="0" max="100" style="width:400px;"></progress>
    <p id="uploaded_text"></p>
</form>
<div class="chart" id="available_space_graph"></div>
<script>
    document.title = window.location.host + window.location.pathname;

    jQuery(document).ready(function ($) {
        $(window).on('popstate', function () {
            location.reload(true);
        })
    })

    function check() {
        var folder_name = _("folder_name").value;
        var not_allowed = ["&", "/", "%", "~", "..", "="];
        var create_button = _("create_folder_button");
        var error_message = _("error");
        if (folder_name.length > 255) {
            error_message.innerHTML = "Names must not be longer than 255 characters";
            create_button.disabled = true;
            return;
        }
        if (not_allowed.some(letter => folder_name.includes(letter))) {
            error_message.innerHTML = "Names must not contain the following: " + not_allowed.join(" ");
            create_button.disabled = true;
            return;
        }
        error_message.innerHTML = "";
        create_button.disabled = false;

    }

    async function done_uploading() {
        _("uploaded_text").innerHTML = "File uploaded, refreshing in 3";
        await sleep(1000);
        _("uploaded_text").innerHTML = "File uploaded, refreshing in 2";
        await sleep(1000);
        _("uploaded_text").innerHTML = "File uploaded, refreshing in 1";
        await sleep(1000);
        location.reload();
    }

    function uploadFile() {
        var fd = new FormData();
        fd.append('file', _("file1").files[0]);
        $.ajax({
            xhr: function () {
                var xhr = new window.XMLHttpRequest();

                xhr.upload.addEventListener("progress", function (evt) {
                    if (evt.lengthComputable) {
                        var percentComplete = evt.loaded / evt.total;
                        percentComplete = parseInt(percentComplete * 100);
                        console.log(percentComplete);
                        _("progressBar").value = percentComplete;
                        _("uploaded_text").innerHTML = percentComplete + "%";
                        if (percentComplete === 100) {
                        }

                    }
                }, false);

                return xhr;
            },
            url: "#",
            type: "POST",
            data: fd,
            processData: false,
            contentType: false,
            success: function (result) {
                done_uploading().then();
            }
        });
    }

    async function zipCheck(id) {
        var td = document.createElement('td');
        var canvas = document.createElement('canvas');
        canvas.className = "inline_canvas";
        td.appendChild(canvas);
        _("row" + id).appendChild(td);
        var ctx = canvas.getContext('2d');
        var size = 20, linewidth = 4;
        canvas.width = canvas.height = size;
        var folder_name = _("row" + id).firstChild.nextSibling.firstChild.title; // !!! this will change if structure of table changes !!!
        console.log(window.location.pathname + folder_name + "~/check");
        var nr_fails = 0;
        var drawCircle = function (percentage) {
            ctx.clearRect(0, 0, size, size);
            ctx.beginPath();
            ctx.strokeStyle = '#efefef';
            ctx.arc(size / 2, size / 2, (size - linewidth) / 2, 0, 2 * Math.PI, false);
            ctx.stroke();
            ctx.beginPath();
            ctx.strokeStyle = 'rgb(255, 0, 0)';
            ctx.arc(size / 2, size / 2, (size - linewidth) / 2, -Math.PI / 2, 2 * Math.PI * percentage - Math.PI / 2, false);
            ctx.stroke();
        }
        while (true) {
            $.ajax({
                xhr: function () {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState == 2) {
                            xhr.responseType = "text";
                            if (xhr.status != "200")
                                nr_fails++;
                        }
                    };
                    return xhr;
                },
                url: window.location.pathname + folder_name + "/~check",
                type: "GET",
                processData: false,
                success: function (data) {
                    const sizes = data.split(" ");
                    var cur_size = parseInt(sizes[0]);
                    var total_size = parseInt(sizes[1]);
                    percentage = cur_size / total_size;
                    requestAnimationFrame(function () { drawCircle(percentage) });
                }
            });
            if (nr_fails >= 2)
                break;
            await sleep(200);
        }
        percentage = 1;
        requestAnimationFrame(drawCircle);
        await sleep(200);
        _("row" + id).removeChild(td);
    }

    window.onload = function () {
        var used = Number(_("used_space").innerHTML);
        var available = Number(_('free_space').innerHTML);
        _("free_space").remove();
        _("used_space").remove();
        var el = _('available_space_graph');
        var options = {
            percent: used / available * 100,
            size: el.getAttribute('data-size') || 220,
            lineWidth: el.getAttribute('data-line') || 15,
            rotate: el.getAttribute('data-rotate') || 0
        }
        var canvas = document.createElement('canvas');
        el.appendChild(document.createElement('br'));
        el.appendChild(document.createElement('br'));
        el.appendChild(document.createElement('br'));
        var span = document.createElement('span');
        span.textContent = Math.round((used / Math.pow(2, 30)) * 100) / 100 + " / " + Math.round(available / Math.pow(2, 30));
        if (typeof (G_vmlCanvasManager) !== 'undefined') {
            G_vmlCanvasManager.initElement(canvas);
        }
        var ctx = canvas.getContext('2d');
        canvas.width = canvas.height = options.size;
        el.appendChild(span);
        var span2 = document.createElement('span');
        span2.textContent = "GB used";
        el.appendChild(span2);
        el.appendChild(canvas);
        ctx.translate(options.size / 2, options.size / 2);
        ctx.rotate((-1 / 2 + options.rotate / 180) * Math.PI);
        var radius = (options.size - options.lineWidth) / 2;
        var drawDoubleCircle = function (bg_color, lineWidth, bg_percent, fg_percent, current) {
            ctx.clearRect(-options.size / 2, -options.size / 2, options.size, options.size);
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, Math.PI * 2 * current / bg_percent, false);
            ctx.strokeStyle = bg_color;
            ctx.lineCap = 'round';
            ctx.lineWidth = lineWidth;
            ctx.stroke();
            var current_fill = current / bg_percent * fg_percent / 100;
            ctx.strokeStyle = "rgb(" + (current_fill * 255) + "," + ((Math.max(1 - current_fill, 0.1)) * 255) + "," + 0 + ")";
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, Math.PI * 2 * current / bg_percent * fg_percent / 100, false);
            ctx.stroke();
            if (current < bg_percent) {
                requestAnimationFrame(function () {
                    drawDoubleCircle(bg_color, lineWidth, bg_percent, fg_percent, current + 1);
                });
            }
        };
        drawDoubleCircle('#efefef', options.lineWidth, 100, options.percent, 0);
    }
</script>