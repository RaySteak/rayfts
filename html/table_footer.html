<tr>
    <th colspan="3">
        <hr>
    </th>
</tr>
</tbody>
</table>
<input type="submit" value="Delete selected">
<div class="gap-20"></div>
</form>
<form method="post">
    <input type="text" name="folder_name" placeholder="Folder name" id="folder_name" onkeyup="check()" required>
    <input type="submit" value="Create folder" id="create_folder_button">
    <div class="gap-20" id="error"></div>
</form>
<form method="post" enctype="multipart/form-data">
    <input type="file" id="file1" name="filename" onchange="uploadFile()">
    <br>
    <progress id="progressBar" value="0" max="100" style="width:400px;"></progress>
    <p id="uploaded_text"></p>
</form>
</body>
<script>
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function _(el) {
        return document.getElementById(el);
    }

    function check() {
        var folder_name = _("folder_name").value;
        var not_allowed = ["&", "/", "%", "~", "..", "="];
        var create_button = _("create_folder_button");
        var error_message = _("error");
        if (folder_name.length > 255) {
            error_message.innerHTML = "Names must not be longer than 255 characters";
            create_button.disabled = true;
            return;
        }
        if (not_allowed.some(letter => folder_name.includes(letter))) {
            error_message.innerHTML = "Names must not contain the following: " + not_allowed.join(" ");
            create_button.disabled = true;
            return;
        }
        error_message.innerHTML = "";
        create_button.disabled = false;

    }

    async function done_uploading() {
        _("uploaded_text").innerHTML = "File uploaded, refreshing in 3";
        await sleep(1000);
        _("uploaded_text").innerHTML = "File uploaded, refreshing in 2";
        await sleep(1000);
        _("uploaded_text").innerHTML = "File uploaded, refreshing in 1";
        await sleep(1000);
        location.reload();
    }

    function uploadFile() {
        var fd = new FormData();
        fd.append('file', _("file1").files[0]);
        $.ajax({
            xhr: function () {
                var xhr = new window.XMLHttpRequest();

                xhr.upload.addEventListener("progress", function (evt) {
                    if (evt.lengthComputable) {
                        var percentComplete = evt.loaded / evt.total;
                        percentComplete = parseInt(percentComplete * 100);
                        console.log(percentComplete);
                        _("progressBar").value = percentComplete;
                        _("uploaded_text").innerHTML = percentComplete + "%";
                        if (percentComplete === 100) {
                        }

                    }
                }, false);

                return xhr;
            },
            url: "#",
            type: "POST",
            data: fd,
            processData: false,
            contentType: false,
            success: function (result) {
                done_uploading().then();
            }
        });
    }

    function downloadFolder(filename) {
        $.ajax({
            xhr: function () {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 2) {
                        if (xhr.status == 200) {
                            xhr.responseType = "blob";
                        } else {
                            xhr.responseType = "text";
                        }
                    }
                };
                return xhr;
            },
            url: "~archive",
            type: "POST",
            data: "folder=" + filename,
            processData: false,
            contentType: "application/x-www-form-urlencoded",
            success: function (data) {
                var blob = new Blob([data], { type: "application/zip" });
                var url = window.URL || window.webkitURL;
                link = url.createObjectURL(blob);
                var a = $("<a />");
                a.attr("download", filename);
                a.attr("href", link);
                $("body").append(a);
                a[0].click();
                $("body").remove(a);
            }
        });
    }
</script>